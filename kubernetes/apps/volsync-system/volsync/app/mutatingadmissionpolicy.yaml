---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicybinding-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: volsync-mover-jitter
spec:
  policyName: volsync-mover-jitter
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicy-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: volsync-mover-jitter
  namespace: volsync-system
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["jobs"]
  matchConditions:
    - name: has-volsync-job-name-prefix
      expression: >
        object.metadata.name.startsWith("volsync-src-")
    - name: has-volsync-created-by-labels
      expression: >
        object.metadata.labels["app.kubernetes.io/created-by"] == "volsync"
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: >
          [
            JSONPatch{
              op: "add", path: "/spec/template/spec/initContainers",
              value: []
            },
            JSONPatch{
              op: "add", path: "/spec/template/spec/initContainers/-",
              value: {
                "name": "jitter",
                "image": "docker.io/library/busybox:latest",
                "imagePullPolicy": "IfNotPresent", 
                "command": ["sh", "-c", "sleep $(shuf -i 0-60 -n 1)"]
              }
            }
          ]
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicybinding-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: volsync-mover-smb
spec:
  policyName: volsync-mover-smb
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicy-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: volsync-mover-smb
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["jobs"]
  matchConditions:
    - name: has-volsync-job-name-prefix
      expression: >
        object.metadata.name.startsWith("volsync-")
    - name: has-volsync-created-by-labels
      expression: >
        object.metadata.labels["app.kubernetes.io/created-by"] == "volsync"
    - name: repository-volume-does-not-exist
      expression: >
        !object.spec.template.spec.volumes.exists(item, item.name == "repository")
  failurePolicy: Fail
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: >
          [
            JSONPatch{
              op: "add", 
              path: "/spec/template/spec/containers/0/volumeMounts/-",
              value: {
                "name": "repository",
                "mountPath": "/repository"
              }
            },
            JSONPatch{
              op: "add", 
              path: "/spec/template/spec/volumes/-",
              value: {
                "name": "repository",
                "hostPath": {
                  "path": "/mnt/smb-volsync",
                  "type": "DirectoryOrCreate"
                }
              }
            },
            JSONPatch{
              op: "add",
              path: "/spec/template/spec/initContainers",
              value: []
            },
            JSONPatch{
              op: "add",
              path: "/spec/template/spec/initContainers/-",
              value: {
                "name": "smb-mount",
                "image": "docker.io/library/alpine:latest",
                "securityContext": {
                  "privileged": true
                },
                "command": [
                  "sh",
                  "-c",
                  "apk add --no-cache cifs-utils && mkdir -p /mnt/smb-volsync && mount -t cifs //unaspro.internal/volsync /mnt/smb-volsync -o username=${SMB_USER},password=${SMB_PASSWORD},vers=3.0,dir_mode=0755,file_mode=0644"
                ],
                "env": [
                  {
                    "name": "SMB_USER",
                    "valueFrom": {
                      "secretKeyRef": {
                        "name": "volsync-smb-unaspro",
                        "key": "username"
                      }
                    }
                  },
                  {
                    "name": "SMB_PASSWORD",
                    "valueFrom": {
                      "secretKeyRef": {
                        "name": "volsync-smb-unaspro",
                        "key": "password"
                      }
                    }
                  }
                ]
              }
            }
          ]
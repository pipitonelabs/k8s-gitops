---
# Keep the jitter policy and binding as they are independent of the storage type
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicybinding-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicyBinding
metadata:
  name: volsync-mover-jitter
spec:
  policyName: volsync-mover-jitter
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicy-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  name: volsync-mover-jitter
  # Assuming volsync runs in volsync-system, adjust if needed
  namespace: volsync-system
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["jobs"]
  matchConditions:
    - name: has-volsync-job-name-prefix
      expression: >
        object.metadata.name.startsWith("volsync-src-") # Only apply jitter to source jobs
    - name: has-volsync-created-by-labels
      expression: >
        object.metadata.labels["app.kubernetes.io/created-by"] == "volsync"
  failurePolicy: Ignore # Typically safer to Ignore failure for non-essential mutations like jitter
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: >
          [
            # Ensure initContainers array exists (idempotency)
            has(object.spec.template.spec.initContainers) ? {} : JSONPatch{op: "add", path: "/spec/template/spec/initContainers", value: []},
            # Add the jitter initContainer
            JSONPatch{
              op: "add", path: "/spec/template/spec/initContainers/-",
              value: { # Use standard map notation for clarity
                "name": "jitter",
                "image": "docker.io/library/busybox:latest",
                "imagePullPolicy": "IfNotPresent",
                "command": ["sh", "-c", "sleep $(shuf -i 0-60 -n 1)"]
              }
            }
          ]
---
# Binding for the new SMB policy
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicybinding-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicyBinding
metadata:
  # Rename to reflect SMB
  name: volsync-mover-smb
spec:
  # Point to the new SMB policy name
  policyName: volsync-mover-smb
  # You might want to scope this binding to specific namespaces if needed
  # matchResources:
  #   namespaceSelector:
  #     matchLabels:
  #       some-label: some-value
---
# Updated policy for SMB volume mounting
# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.32.0/mutatingadmissionpolicy-admissionregistration-v1alpha1.json
apiVersion: admissionregistration.k8s.io/v1alpha1
kind: MutatingAdmissionPolicy
metadata:
  # Rename to reflect SMB
  name: volsync-mover-smb
  # Assuming volsync runs in volsync-system, adjust if needed
  namespace: volsync-system
spec:
  matchConstraints:
    resourceRules:
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["jobs"]
  matchConditions:
    - name: has-volsync-job-name-prefix
      expression: >
        # Apply to both source (src-) and destination (dst-) mover jobs if needed
        object.metadata.name.startsWith("volsync-")
    - name: has-volsync-created-by-labels
      expression: >
        object.metadata.labels["app.kubernetes.io/created-by"] == "volsync"
    - name: repository-volume-does-not-exist
      expression: >
        !has(object.spec.template.spec.volumes) || !object.spec.template.spec.volumes.exists(item, item.name == "repository")
  failurePolicy: Fail # Failing is appropriate if storage cannot be attached
  reinvocationPolicy: IfNeeded
  mutations:
    - patchType: JSONPatch
      jsonPatch:
        expression: >
          [
            # Ensure volumeMounts array exists in the first container (idempotency)
            has(object.spec.template.spec.containers[0].volumeMounts) ? {} : JSONPatch{op: "add", path: "/spec/template/spec/containers/0/volumeMounts", value: []},
            # Add the volumeMount
            JSONPatch{
              op: "add", path: "/spec/template/spec/containers/0/volumeMounts/-",
              value: { # Use standard map notation
                "name": "repository",
                "mountPath": "/repository"
              }
            },
            # Ensure volumes array exists (idempotency)
            has(object.spec.template.spec.volumes) ? {} : JSONPatch{op: "add", path: "/spec/template/spec/volumes", value: []},
            # Add the SMB CSI volume definition
            JSONPatch{
              op: "add", path: "/spec/template/spec/volumes/-",
              value: { # Use standard map notation
                "name": "repository",
                "csi": {
                  "driver": "smb.csi.k8s.io", # Standard SMB CSI driver name
                  "readOnly": false,
                  # !! IMPORTANT: Replace smb-credentials and volsync-system !!
                  "nodeStageSecretRef": {
                    "name": "volsync-smb-unaspro",       # <-- CHANGE TO YOUR SECRET NAME
                    "namespace": "volsync-system"   # <-- CHANGE TO YOUR SECRET NAMESPACE
                  },
                  # Use a unique handle, often derived from the share path
                  "volumeHandle": "volsync-unaspro-internal-volsync",
                  "volumeAttributes": {
                    # Use forward slashes for UNC paths in Kubernetes
                    "source": "//unaspro.internal/Volsync",
                    # Add mount options if needed, e.g. "dir_mode=0777,file_mode=0777"
                    # "mountOptions": "dir_mode=0777,file_mode=0777"
                  }
                }
              }
            }
          ]